<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AniList Anime Player</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
  select, button, input { margin: 10px 0; padding: 8px; width: 100%; box-sizing: border-box; }
  #modal {
    display: none;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center; align-items: center;
    z-index: 1000;
  }
  #modal iframe {
    width: 80%; height: 80%;
  }
  #modalClose {
    position: absolute; top: 20px; right: 30px;
    font-size: 30px; color: white; cursor: pointer;
  }
  label { font-weight: bold; margin-top: 15px; display: block; }
</style>
</head>
<body>

<h1>AniList Anime Player</h1>

<label for="searchInput">Search Anime (e.g. "hero"):</label>
<input id="searchInput" type="text" placeholder="Type to search anime..." />

<label for="animeSelect">Anime:</label>
<select id="animeSelect" disabled>
  <option value="" disabled selected>Select an anime</option>
</select>

<label for="episodeSelect">Episode:</label>
<select id="episodeSelect" disabled>
  <option value="" disabled selected>Select episode</option>
</select>

<label for="langSelect">Language:</label>
<select id="langSelect" disabled>
  <option value="sub">Sub</option>
  <option value="dub">Dub</option>
</select>

<button id="playBtn" disabled>Play</button>

<div id="modal">
  <span id="modalClose">&times;</span>
  <iframe id="playerFrame" src="" frameborder="0" allowfullscreen scrolling="no"></iframe>
</div>

<script>
// Elements
const searchInput = document.getElementById("searchInput");
const animeSelect = document.getElementById("animeSelect");
const episodeSelect = document.getElementById("episodeSelect");
const langSelect = document.getElementById("langSelect");
const playBtn = document.getElementById("playBtn");
const modal = document.getElementById("modal");
const modalClose = document.getElementById("modalClose");
const playerFrame = document.getElementById("playerFrame");

// Store fetched anime list with episodes info
let currentAnimeList = [];
// Store user input mapping of episode number => hianime episode ID for the selected anime
let episodeIdMap = {};

// AniList GraphQL query to search anime by keyword
const query = `
query ($search: String) {
  Page(page: 1, perPage: 10) {
    media(search: $search, type: ANIME) {
      id
      title {
        romaji
      }
      episodes
    }
  }
}
`;

// Fetch anime list by search term
async function fetchAnimeList(searchTerm) {
  animeSelect.disabled = true;
  episodeSelect.disabled = true;
  langSelect.disabled = true;
  playBtn.disabled = true;
  animeSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
  episodeSelect.innerHTML = '<option value="" disabled selected>Select episode</option>';
  
  try {
    const response = await fetch('https://graphql.anilist.co', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query, variables: { search: searchTerm } })
    });
    const data = await response.json();
    if (data.errors) {
      throw new Error(data.errors[0].message);
    }
    return data.data.Page.media;
  } catch (e) {
    alert("Error fetching anime list: " + e.message);
    return [];
  }
}

// Debounce function to limit calls
function debounce(fn, delay) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => fn(...args), delay);
  };
}

// When user types search term
const onSearchChange = debounce(async () => {
  const term = searchInput.value.trim();
  if (term.length < 2) {
    animeSelect.innerHTML = '<option value="" disabled selected>Type at least 2 chars to search</option>';
    animeSelect.disabled = true;
    episodeSelect.disabled = true;
    langSelect.disabled = true;
    playBtn.disabled = true;
    return;
  }
  
  currentAnimeList = await fetchAnimeList(term);
  episodeIdMap = {}; // reset map on new search
  
  animeSelect.innerHTML = '<option value="" disabled selected>Select an anime</option>';
  currentAnimeList.forEach((anime, idx) => {
    const epCountText = anime.episodes ? `(${anime.episodes} episodes)` : '(Unknown episodes)';
    const option = document.createElement("option");
    option.value = idx;
    option.textContent = `${anime.title.romaji} ${epCountText}`;
    animeSelect.appendChild(option);
  });
  animeSelect.disabled = currentAnimeList.length === 0;
  episodeSelect.disabled = true;
  langSelect.disabled = true;
  playBtn.disabled = true;
}, 500);

searchInput.addEventListener("input", onSearchChange);

// When anime selected, populate episode dropdown
animeSelect.addEventListener("change", () => {
  episodeSelect.innerHTML = '<option value="" disabled selected>Select episode</option>';
  langSelect.disabled = true;
  playBtn.disabled = true;
  episodeIdMap = {}; // reset mapping for new anime

  const anime = currentAnimeList[animeSelect.value];
  if (!anime || !anime.episodes) {
    episodeSelect.disabled = true;
    return;
  }
  for(let i = 1; i <= anime.episodes; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `Episode ${i}`;
    episodeSelect.appendChild(option);
  }
  episodeSelect.disabled = false;
});

// When episode selected, prompt user to enter hianime episode ID (if not saved)
episodeSelect.addEventListener("change", () => {
  langSelect.disabled = true;
  playBtn.disabled = true;
  const epNum = episodeSelect.value;
  if (!epNum) return;

  // If we have saved id already, skip prompt
  if (episodeIdMap[epNum]) {
    langSelect.disabled = false;
    return;
  }
  
  // Prompt user for hianime ep id
  const epId = prompt(`Enter hianime episode ID for episode ${epNum}.\nYou can get it from hianime.to URL "?ep=" parameter.`);
  if (epId && epId.trim() !== "") {
    episodeIdMap[epNum] = epId.trim();
    langSelect.disabled = false;
  } else {
    // If user cancels or inputs nothing, reset episode selection
    episodeSelect.value = "";
  }
  playBtn.disabled = true;
});

langSelect.addEventListener("change", () => {
  if (episodeSelect.value && langSelect.value) {
    playBtn.disabled = false;
  } else {
    playBtn.disabled = true;
  }
});

// Play button click handler - open modal and play video
playBtn.addEventListener("click", () => {
  const anime = currentAnimeList[animeSelect.value];
  const epNum = episodeSelect.value;
  const lang = langSelect.value;

  if (!anime || !epNum || !lang) return alert("Please select anime, episode and language.");

  const epId = episodeIdMap[epNum];
  if (!epId) return alert("Episode ID not found. Please enter it.");

  const embedUrl = `https://megaplay.buzz/stream/s-2/${epId}/${lang}`;
  playerFrame.src = embedUrl;
  modal.style.display = "flex";
});

// Close modal
modalClose.addEventListener("click", () => {
  modal.style.display = "none";
  playerFrame.src = "";
});

// Close modal on outside click
modal.addEventListener("click", e => {
  if (e.target === modal) {
    modalClose.click();
  }
});
</script>

</body>
</html>
